
<html>


<head>
	<title>Emilee Chen - CS194-26 Project 7</title>
	<link rel="stylesheet" type="text/css" href="css.css"> 
</head>


<body>
	<div id="wrap">

		<div id="header">

			<div id="name">
				CS194-26 &#8226; Project 7 &#8226; Emilee Chen <br>
				<div id="sub">
					Image Warping and Mosaicing
				</div>
			</div>
			<div id="info-container">
				<div id="info">
					<p>
						CS194-26 FA'15 <br>
						Emilee Chen (cs194-bb) <br>
						echen at berkeley dot edu
					</p>
					<p>
						This is the seventh project for the class <a href="http://inst.eecs.berkeley.edu/~cs194-26/fa15/" target="_blank">CS194-26: Image Manipulation and Computational Photography</a> taught by Professor Alexei Efros at UC Berkeley.
					</p>
				</div>
			</div>
		</div>



		<div id="content">

			<h1>I. Introduction</h1>

				<p>
					The objective of this project is to be able to stitch a mosaic from a series of images with manually selected corresponding points. The process can be described in three steps:

					<ol>
						<p>
							<li>Shoot images so that the transforms between them are projective.</li>
							These images must be shot from the same point of view so that we can unproject, rotate, and then reproject (this is called homography) to align them.
						</p>
						<p>
							<li>Recover the homography of the images.</li>
							Given a series of (at least four) corresponding points on two images, we can estimate a homography and find a homography matrix. I referenced slides 25-30 from <a href="http://www.cse.psu.edu/~rtc12/CSE486/lecture16.pdf" target="_blank">Robert Collins' CSE486 Lecture Slides</a>.
						</p>
						<p>
							<li>Warp images using the homography.</li>
							Now that we have the parameters of hte homography, it is a simple process of inverse warping the image by H.
						</p>
						<p>
							<li>Blend the warped images together.</li>
							Finally, blend the two images together to create a (hopefully) seamless mosaic.
						</p>
					</ol>
				</p>

				<p>
					To improve upon this, automatic mosaicing is also implemented. This entails the automatic selection of likely points and further refining those points and finding the correspondences. A more detailed, step by step explanation is available <a href="#auto">below</a>.
				</p>


			<h1>II. Image Rectification</h1>

				<p>
					After retreiving a homography matrix, whether or not the implemented warping is working correctly or not can be determined by using it to rectify an image. This is simply taking an image of an object from an angle for which we know the object's true shape, and morph the image into that shape.
				</p>

				<p>
					I did this on a photo of the portrait I was working on. The picture was taken at an angle, so the drawing board is trapezoidal in the photo even though we know it to be rectangular. Image rectification recovers the rectangular drawing board as if it were viewed head on. The original points were chosen manually, and the new points were chosen manually as well, through guess and check to ensure the correct width to height ratios were used.
				</p>

				<center>
					<table>
						<tr>
							<td>
								<img src="img/studio.jpg">
								<div class="code subbb">
									original
								</div>
							</td>
							<td>
								<img src="img/studio_rec.jpg">
								<div class="code subbb">
									rectified
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="2">
								Photo of my drawing setup in Kroeber one afternoon. Points were selected within the drawing board to create a rectangle around the paper and references.
							</td>
						</tr>
					</table>
				</center>

				<center>
					<table>
						<tr>
							<td>
								<img src="img/polaroid.jpg">
								<div class="code subbb">
									original
								</div>
							</td>
							<td>
								<img src="img/polaroid_rec.jpg">
								<div class="code subbb">
									rectified
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="2">
								Photo of my polaroid wall. Points were selected to create a rectangle around the 5 by 4 fully pictured polaroids.
							</td>
						</tr>
					</table>
				</center>

				<p>
					I discovered that there are images that don't look quite right when rectified. At first I tried to rectify this image of some bookshelves in Main Stacks. As you can see below, the rectified image looks oddly mishapen, especially in regards to the spinning handles. This is because the handles (as well as the signs) stick out from the flat surface of the bookshelves. When you look solely at the flat surface of the bookselves, though, they are correctly rectified.
				</p>

				<center>
					<table>
						<tr>
							<td>
								<img src="img/stacks.jpg">
								<div class="code subbb">
									original
								</div>
							</td>
							<td>
								<img src="img/stacks_rec.jpg">
								<div class="code subbb">
									rectified
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="2">
								Photo of some bookshelves in Main Stacks. Points were selected to create a rectangle around the bookshelves on the right.
							</td>
						</tr>
					</table>
				</center>


			<h1>III. Mosaicing</h1>

				<p>
					Now that we know that our homography matrix is working, we can finally stitch some photos together and make mosaics! When I was first working on this project, I was in MLK, so I took some quick pictures with my iPhone for testing. I thought then that not having a tripod would produce unappealing ghosting in my mosaics, but as long as I tried my best to pivot my phone about where the camera is (and look very weird while doing it, I'm sure), the results were quite good. Unfortunately, since my phone does auto adjustments for brightness, contrast, exposure, etc. some of the images don't match each other in colour. I had to go in and manually adjust the image until it matched the others better.
				</p>

				<center>
					<table>
						<tr>
							<td>
								<img src="img/u/d.jpg">
							</td>
							<td>
								<img src="img/u/e.jpg">
							</td>
							<td>
								<img src="img/u/f.jpg">
								<div class="code subbb">
									original images
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="3">
								<img src="img/u_manual.jpg">
								<div class="code subbb">
									manually stitched
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="3">
								A series of photos taken in the U (MLK) one afternoon featuring studious Cal students. I manually stitched together these images with only translation and rotation to get a feel as to how the mosaic should look in the end.
							</td>
						</tr>
					</table>
				</center>

				<p>
					To combine two images, we need at least four corresponding points from each image to make a homography matrix. I used around 10 points for each pair of images. When mosaicing two images together, I averaged the points and warped both images toward that average. When mosaicing three images together, I warped the left and right images towards the centre image.
				</p>

				<p>
					To determine the size of the image image, I simply used the corresponding homography matrices on the left images' left corners, and the right images' right corners and took the min (for left image) or max (for right side) of the x and y values. This gives me some set of negative and positive numbers such as <span class="code">[-545, -267, 1065, 481]</span>, which are the min x value, min y value, max x value, and max y value of the final image. The size of the image can be easily found with these values, and all that is needed from there is to offset the pixels being put onto the final image by the min values.
				</p>

				<center>
					<table>
						<tr>
							<td>
								<img src="img/u_overwrite.jpg">
								<div class="code subbb">
									overwrite
								</div>
							</td>
						</tr>
						<tr>
							<td>
								The images overwrite each other when no blending technique is used, creating harsh edges.
							</td>
						</tr>
					</table>
				</center>

				<p>
					Although the mosaic looks very nice and aligned in terms of features within the image, there are still obvious harsh edges where one image ends and another begins. Some blending technique must be used to eliminate these edges. I chose to implement linear blending. I simply took the x-axis range of where two images overlap (with the same process as finding the final image's width and height) and created a linear gradient into the next image. To calculate the weight is a simple <span class="code">1 - (x - (left edge x-value)) / ((right edge x-value) - (left edge x-value))</span>. Take 1 minus that value for the weight of the other image.
				</p>

				<center>
					<table>
						<tr>
							<td>
								<img src="img/u_linear.jpg">
								<div class="code subbb">
									linear blending
								</div>
							</td>
						</tr>
						<tr>
							<td>
								Linear blending across each image creates a smooth result.
							</td>
						</tr>
					</table>
				</center>

				<p>
					This process does still leave some edges along the top and bottom of the images, but cropping can elimiate those edges without taking too much away from the mosaic. The reason linear blending worked so well is because the images and points were taken and chosen with care. If the homography did not correctly align the images, there would be ghosting, and the blending would not have worked as well as it did.
				</p>

				<center>
					<table>
						<tr>
							<td>
								<img src="img/u.jpg">
							</td>
						</tr>
						<tr>
							<td>
								The final image looks quite seamless after cropping.
							</td>
						</tr>
					</table>
				</center>

				<p>
					Below is a series of other images that I mosaic'd together with the same process. 
				</p>

				<center>
					<table>
						<tr>
							<td>
								<img src="img/sunset/a.jpg">
							</td>
							<td>
								<img src="img/sunset/b.jpg">
							</td>
							<td>
								<img src="img/sunset/c.jpg">
								<div class="code subbb">
									original images
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="3">
								<img src="img/sunset_manual.jpg">
								<div class="code subbb">
									manually stitched
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="3">
								<img src="img/sunset_linear.jpg">
								<div class="code subbb">
									linear blending
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="3">
								<img src="img/sunset.jpg">
								<div class="code subbb">
									final
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="3">
								Tilden Park at sunset.
							</td>
						</tr>
					</table>
				</center>



				<center>
					<table>
						<tr>
							<td>
								<img src="img/union/b.jpg">
							</td>
							<td>
								<img src="img/union/c.jpg">
							</td>
							<td>
								<img src="img/union/d.jpg">
								<div class="code subbb">
									original images
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="3">
								<img src="img/union_manual.jpg">
								<div class="code subbb">
									manually stitched
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="3">
								<img src="img/union_linear.jpg">
								<div class="code subbb">
									linear blending
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="3">
								<img src="img/union.jpg">
								<div class="code subbb">
									final
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="3">
								View from the holiday Union Square ice rink.
							</td>
						</tr>
					</table>
				</center>

			
			<a name="auto"></a>
			<h1>V. Automatic Mosaicing</h1>

				<p>
					Although the finished mosaics look quite nice, it is very time consuming to go through and find matching points for every image that you want to stitch. So, the key to automatic mosaic stitching is automatic corresponding point selection.
				</p>

				<p>
					This process is actually quite simple, although it does require several rounds of pruning to ensure there are no false positives. The steps are outlined below:

					<ol>
						<p>
							<li>Use the <b>Harris Interest Point Detector</b> method to find possible points of interest.</li>
							It takes in an image and finds all the Harris corners in the image. I used the provided <a href="https://inst.eecs.berkeley.edu/~cs194-26/fa15/hw/proj7-stitch/harris.py" target="_blank">harris.py</a>.
						</p>
						<p>
							<li>Use the <b>Adaptive Non-Maximal Suppression</b> strategy on the list of points.</li>
							We want to restrict the maximum number of points in our list as feature matching in the next step is expensive. This strategy makes sure that we take a certain number of points that are spread evenly across the image, but also weighted according to how strong their respective corners are. 
						</p>
						<p>
							<li>Extract the <b>feature descriptor</b> for each point.</li>
							Points must be compared as a feature, which is basically the patch around a point. These descriptors are the 40 by 40 patch around the point downsized to 8 by 8.
						</p>
						<p>
							<li><b>Feature match</b> each feature of each point.</li>
							Each feature descriptor of the left image is compared against each feature descriptor of the right image using SSD to find the best fitting right feature for each left feature.
						</p>
						<p>
							<li>Use 4 point <b>RANSAC</b> to compute a robust homography estimate.</li>
							Randomly select four points from the list of possible corresponding points to create a homography and see how many of all the points match. Repeat for a set amount of trials. Select the best trial and use the non-discarded points to create a homography.
						</p>
					</ol>
				</p>

				<p>
					I took the previous images of Tilden Park for which I had created a mosaic for with manually selected points to use automatic mosaicing on.
				</p>

				<center>
					<table>
						<tr>
							<td>
								<img src="img/7a.jpg">
							</td>
							<td>
								<img src="img/7b.jpg">
								<div class="code subbb">
									original images
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="2">
								Tilden Park at sunset. These are the original images used to create the mosaic.
							</td>
						</tr>
					</table>
				</center>

				<p>
					The Harris corners of each image are found with the provided harris.py mentioned earlier.
				</p>

				<center>
					<table>
						<tr>
							<td>
								<img src="img/7a7bharris1.jpg">
							</td>
							<td>
								<img src="img/7a7bharris2.jpg">
								<div class="code subbb">
									harris corners
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="2">
								Each of the Harris corners found are plotted as points in red.
							</td>
						</tr>
					</table>
				</center>

				<p>
					Adaptive Non-Maximal Suppression, or ANMS, is a strategy that selects only the most important and spread out <span class="code">n</span> points so that only a small amount of feature descriptors must be calculated and compared. I chose <span class="code">n = 300</span> as I tend to work with smaller images. To explain this method in a most basic sense: using each point's h value, we can find radi for each point, which ranks the importance of each point. I selected the top <span class="code">n</span> points with the maximum radius to continue on to the next step.
				</p>

				<p>
					Since I used images that are on the small side, no points were pruned as there were less inital Harris corners than my maximum selected points.
				</p>

				<center>
					<table>
						<tr>
							<td>
								<img src="img/7a7banms1.jpg">
							</td>
							<td>
								<img src="img/7a7banms2.jpg">
								<div class="code subbb">
									after anms
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="2">
								Each of the interest points that weren't pruned by ANMS are plotted as points in blue.
							</td>
						</tr>
					</table>
				</center>

				<p>
					Now that we have a reasonable number of points, the next step is to find corresponding points in the other image. To do this, we must consider the feature descriptor of each point. We want these feature descriptors to contain as much information as possible while being small so that the following step will be less computationally expensive. To prepare these feature descriptors, we need to massage it into a format that allows for easy and fast feature comparison computation. I took the 40 by 40 patch around each point and used a Gaussian blur on to before downsizing it to an 8 by 8 patch by selecting every 5th pixel to use in the new patch.
				</p>

				<center>
					<table>
						<tr>
							<td>
								<img src="img/7a7bfeat1.jpg">
							</td>
							<td>
								<img src="img/7a7bfeat2.jpg">
								<div class="code subbb">
									feature descriptors
								</div>
							</td>
						</tr>
							<td colspan="2">
								All the features for each image.
							</td>
					</table>
				</center>

				<p>
					Now that we have our feature descriptors for each image, we can use our basic SSD to see which feature in one images matches which feature of the other image the best.
				</p>

				<center>
					<table>
						<tr>
							<td>
								<img src="img/7a7bmatch1.jpg">
							</td>
							<td>
								<img src="img/7a7bmatch2.jpg">
								<div class="code subbb">
									after matching
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="2">
								Each of the points that got matched with a corresponding point are plotted as points in green.
							</td>
						</tr>
					</table>
				</center>

				<p>
					Although our feature matching algorithm is quite good, there is still a chance of having outlier points. So, we use RANSAC to reject these remaining outliers. The idea is to select some random four points to create a homography matrix (transforming the left points to the right points) and apply it to all the left image points that we have and see how many of them match the corresponding right image points. The points that are within some <span class="code">epsilon</span> of their expected location are accepted as inlier and all other points are discarded as outliers. The number of votes, which is the number of inlier, is saved along with the list of inlier points.
				</p>

				<p>
					This process is repeated some number of trials, t. I chose to use <span class="code">t = 500</span>, since I usually end up with only 20-50 set of points and it produces consistent results. I chose <span class="code">epsilon = 2</span> pixels as suggested by Professor Efros in class. I tried other values, but 2 seems to have the best results.
				</p>

				<center>
					<table>
						<tr>
							<td>
								<img src="img/7a7bfinal1.jpg">
							</td>
							<td>
								<img src="img/7a7bfinal2.jpg">
								<div class="code subbb">
									after ransac
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="2">
								The sets of points that weren't discarded as outliers are plotted as points in yellow.
							</td>
						</tr>
					</table>
				</center>
				
				<p>
					Finally, the point selection process is complete and we will have found a set of corresponding points for the two images. Then we take these points and stitch the images together with the homography matrix just as detailed in the previous section.
				</p>

				<center>
					<table>
						<tr>
							<td>
								<img src="img/7a7b.jpg">
								<div class="code subbb">
									auto stitched mosaic
								</div>
							</td>
						</tr>
						<tr>
							<td>
								<img src="img/7a7bmanual.jpg">
								<div class="code subbb">
									manually stitched mosaic
								</div>
							</td>
						</tr>
						<tr>
							<td>
								The final, automatically stitched mosaic, along with a version with manually selected points.
							</td>
						</tr>
					</table>
				</center>
				
				<p>
					The final result looks better than the manually selected version, which is great! Below are some more examples.
				</p>

				<center>
					<table>
						<tr>
							<td>
								<img src="img/5b.jpg">
							</td>
							<td>
								<img src="img/5c.jpg">
								<div class="code subbb">
									original images
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="2">
								<img src="img/5b5c.jpg">
								<div class="code subbb">
									final (auto) mosaic
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="2">
								<img src="img/5b5cmanual.jpg">
								<div class="code subbb">
									final (manual) mosaic
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="2">
								View from the holiday Union Square ice rink.
							</td>
						</tr>
					</table>
				</center>

				<center>
					<table>
						<tr>
							<td>
								<img src="img/6c.jpg">
							</td>
							<td>
								<img src="img/6d.jpg">
								<div class="code subbb">
									original images
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="2">
								<img src="img/6c6d.jpg">
								<div class="code subbb">
									final mosaic
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="2">
								From the food trucks beside Boalt Hall.
							</td>
						</tr>
					</table>
				</center>

				<center>
					<table>
						<tr>
							<td>
								<img src="img/4a.jpg">
							</td>
							<td>
								<img src="img/4b.jpg">
							</td>
							<td>
								<img src="img/4c.jpg">
							</td>
							<td>
								<img src="img/4d.jpg">
								<div class="code subbb">
									original images
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="2">
								<img src="img/4a4b.jpg">
								<div class="code subbb">
									<a href="img/4a4b.jpg" target="_blank">[x]</a>
								</div>
							</td>
							<td colspan="2">
								<img src="img/4c4d.jpg">
								<div class="code subbb">
									two image mosaics <br>
									<a href="img/4c4d.jpg" target="_blank">[x]</a>
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="4">
								<img src="img/4a4b4c4d.jpg">
								<div class="code subbb">
									final mosaic <br>
									<a href="img/4a4b4c4d.jpg" target="_blank">[x]</a>
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="4">
								The U (MLK) one afternoon featuring studious Cal students. 
							</td>
						</tr>
					</table>
				</center>

				<p>
					Some mosaics have better results when points were manually selected, which is especially noticable in the Union Square mosaic. This is because some areas of the images that would have given helpful points were never selected due to them not being detected as a Harris corner.
				</p>

				<p>
					I came across some issues with several sets of images where no matches or even no corners could be found in the images. This is because I did not implement any allowances for rotation between the features, so if one image was slightly rotated, no matched would be found. I also had to increase the contrast in some of the images in order for any Harris corners to be detected.
				</p>


			<h1>VI. Rotation Invariance</h1>

				<p>
					Another reason why we were not able to find a set of corresponding points in some of the image pairs was because some of the images were rotated not only about the y-axis, but about the z-axis as well. Two features, the same, will not be matched if one is rotated with our basic SSD, which compares pixels individually. To solve this problem, there must be some "correct" orientation for each feature. I simply rotated each feature to align with the gradient direction of that feature.
				</p>

				<p>
					Below is an example of one of the pairs of images for which the automatic point selection process did not succeed. It is quite obvious that the z-axis orientation was not preserved from one image to the next. Take the beige building with yellow lights, for example. It is much more rotated in the left image than the right.
				</p>

				<center>
					<table>
						<tr>
							<td>
								<img src="img/5c.jpg">
							</td>
							<td>
								<img src="img/5d.jpg">
								<div class="code subbb">
									original images
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="2">
								Once again, the view from the holiday Union Square ice rink. These are the original images used for this rotation invariant mosaic.
							</td>
						</tr>
					</table>
				</center>

				<p>
					The process is exactly the same, except that instead of comparing the original features, we compare the rotated features. Now, the false negatives that were discarded as unmatched will be preserved.
				</p>

				<center>
					<table>
						<tr>
							<td>
								<img src="img/5c5drot1.jpg">
							</td>
							<td>
								<img src="img/5c5drot2.jpg">
								<div class="code subbb">
									feature descriptors
								</div>
							</td>
						</tr>
						<tr>
							<td>
								<img src="img/5c5dfeat1.jpg">
							</td>
							<td>
								<img src="img/5c5dfeat2.jpg">
								<div class="code subbb">
									feature patches
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="2">
								All the features aligned with their respective gradient directions.
							</td>
						</tr>
					</table>
				</center>

				<p>
					And horray! A previously unstitchable pair of images can now be stitched.
				</p>

				<center>
					<table>
						</tr>
						<tr>
							<td colspan="2">
								<img src="img/5c5d.jpg">
								<div class="code subbb">
									basic automatic mosaicing
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="2">
								<img src="img/5c5d_rot.jpg">
								<div class="code subbb">
									with rotation invariance
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="2">
								View from the holiday Union Square ice rink, this time using auto mosaicing with rotation invariance.
							</td>
						</tr>
					</table>
				</center>




			<h1>VII. Conclusion</h1>

				<p>
					I have used a lot of image stitching and panoma creating applications, but have never thought about the how they works or the math behind it all. It's really interesting to get to know the basics of how they work and get to see how powerful matrices are.
				</p>

		</div>

	</div>
</body>


</html>